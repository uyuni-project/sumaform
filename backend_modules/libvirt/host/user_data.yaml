#cloud-config

disable_root: false
ssh_pwauth: true
chpasswd:
  expire: false
  list: |
     root:linux

%{ if image == "centos7o" }
yum_repos:
  # repo for salt
  tools_pool_repo:
    baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/CentOS7-Uyuni-Client-Tools/CentOS_7/
    failovermethod: priority
    enabled: true
    gpgcheck: false
    name: tools_pool_repo
  # repo for nss-mdns
  epel:
    baseurl: http://download.fedoraproject.org/pub/epel/7/$basearch
    mirrorlist: https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=$basearch
    failovermethod: priority
    enabled: true
    gpgcheck: false
    name: epel

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ else }
packages: ["salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ endif }
%{ endif }

%{ if image == "centos8o" }
bootcmd:
  # WORKAROUND: yum_repos state cant replace a repo, so we need to delete it,
  # otherwise the workaround for archived repo doesn't work
  - [rm, -f, /etc/yum.repos.d/CentOS-Base.repo, /etc/yum.repos.d/CentOS-AppStream.repo]

yum_repos:
  # repo for salt
  tools_pool_repo:
    baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/EL8-Uyuni-Client-Tools/EL_8/
    enabled: true
    gpgcheck: false
    name: tools_pool_repo
  # repo for nss-mdns
  epel:
    baseurl: http://download.fedoraproject.org/pub/epel/8/Everything/$basearch
    mirrorlist: https://mirrors.fedoraproject.org/metalink?repo=epel-8&arch=$basearch
    enabled: true
    gpgcheck: false
    name: epel
  # repo for Centos-Base backup
  CentOS-Base_backup:
    baseurl: http://vault.centos.org/$contentdir/$releasever/BaseOS/$basearch/os/
    enabled: true
    gpgcheck: false
    name: CentOS-Base_backup
  # repo for Centos-Appstream backup
  CentOS-Appstream_backup:
    baseurl: http://vault.centos.org/$contentdir/$releasever/AppStream/$basearch/os/
    enabled: true
    gpgcheck: false
    name: CentOS-AppStream_backup

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ else }
packages: ["salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ endif }
%{ endif }

%{ if image == "centos9o" }
bootcmd:
  # WORKAROUND: yum_repos state cant replace a repo, so we need to delete it,
  # otherwise the workaround for archived repo doesn't work
  - [rm, -f, /etc/yum.repos.d/CentOS-Base.repo, /etc/yum.repos.d/CentOS-AppStream.repo]

yum_repos:
  # repo for salt
  tools_pool_repo:
    baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/EL9-Uyuni-Client-Tools/EL_9/
    enabled: true
    gpgcheck: false
    name: tools_pool_repo
  # repo for nss-mdns
  epel:
    baseurl: http://download.fedoraproject.org/pub/epel/9/Everything/$basearch
    mirrorlist: https://mirrors.fedoraproject.org/metalink?repo=epel-9&arch=$basearch
    enabled: true
    gpgcheck: false
    name: epel
  # repo for Centos-Base backup
  CentOS-Base_backup:
    baseurl: http://vault.centos.org/$contentdir/$releasever/BaseOS/$basearch/os/
    enabled: true
    gpgcheck: false
    name: CentOS-Base_backup
  # repo for Centos-Appstream backup
  CentOS-Appstream_backup:
    baseurl: http://vault.centos.org/$contentdir/$releasever/AppStream/$basearch/os/
    enabled: true
    gpgcheck: false
    name: CentOS-AppStream_backup

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ else }
packages: ["salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ endif }
%{ endif }

%{ if image == "opensuse154o" || image == "opensuse154-ci-pro" || image == "opensuse154-ci-pr-client" || image == "opensuse155o" || image == "opensuse155-ci-pro"}
zypper:
  repos:
    - id: tools_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/openSUSE_Leap_15-Uyuni-Client-Tools/openSUSE_Leap_15.0/
      enabled: true
      gpgcheck: false
      name: tools_pool_repo

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns"]
%{ else }
packages: ["avahi", "nss-mdns"]
%{ endif }

runcmd:
  - zypper removerepo --all
%{ endif }

%{ if image == "sles12sp4o" }
zypper:
  repos:
    - id: os_pool_repo
      name: os_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs"}/SUSE/Products/SLE-SERVER/12-SP4/x86_64/product/
      enabled: 1
      autorefresh: 1
    - id: tools_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/SLE12-Uyuni-Client-Tools/SLE_12/
      enabled: true
      gpgcheck: false
      name: tools_pool_repo

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ else }
packages: ["avahi", "nss-mdns", "qemu-guest-agent"]
%{ endif }
%{ endif }

%{ if image == "sles12sp5o" }
zypper:
  repos:
    - id: os_pool_repo
      name: os_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs"}/SUSE/Products/SLE-SERVER/12-SP5/x86_64/product/
      enabled: 1
      autorefresh: 1
    - id: tools_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/SLE12-Uyuni-Client-Tools/SLE_12/
      enabled: true
      gpgcheck: false
      name: tools_pool_repo

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ else }
packages: ["avahi", "nss-mdns", "qemu-guest-agent"]
%{ endif }
%{ endif }

%{ if image == "sles15o" }
zypper:
  repos:
    - id: os_pool_repo
      name: os_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs"}/SUSE/Products/SLE-Module-Basesystem/15/x86_64/product
      enabled: 1
      autorefresh: 1
      ## WORKAROUND: name of server app repo needs to be alphabetically after the base system repo to force GPG key update
    - id: server_applications_pool_repo
      name: module_server_applications_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs"}/SUSE/Products/SLE-Module-Server-Applications/15/x86_64/product
      enabled: 1
      autorefresh: 1
    - id: tools_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/SLE15-Uyuni-Client-Tools/SLE_15/
      enabled: true
      gpgcheck: false
      name: tools_pool_repo

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ else }
packages: ["avahi", "nss-mdns", "qemu-guest-agent"]
%{ endif }

runcmd:
  # WORKAROUND: cloud-init in SLES 15 does not take care of the following
  - "systemctl start 'qemu-ga@virtio\\x2dports-org.qemu.guest_agent.0'"
%{ endif }

%{ if image == "sles15sp1o" }
zypper:
  repos:
    - id: os_pool_repo
      name: os_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs"}/SUSE/Products/SLE-Module-Basesystem/15-SP1/x86_64/product
      enabled: 1
      autorefresh: 1
    - id: module_server_applications_pool_repo
      name: module_server_applications_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs"}/SUSE/Products/SLE-Module-Server-Applications/15-SP1/x86_64/product
      enabled: 1
      autorefresh: 1
    - id: tools_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/SLE15-Uyuni-Client-Tools/SLE_15/
      enabled: true
      gpgcheck: false
      name: tools_pool_repo

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ else }
packages: ["avahi", "nss-mdns", "qemu-guest-agent"]
%{ endif }

runcmd:
  # WORKAROUND: cloud-init in SLES 15 SP1 does not take care of the following
  - "systemctl start 'qemu-ga@virtio\\x2dports-org.qemu.guest_agent.0'"
%{ endif }

%{ if image == "sles15sp2o" }
zypper:
  repos:
    - id: os_pool_repo
      name: os_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs"}/SUSE/Products/SLE-Module-Basesystem/15-SP2/x86_64/product
      enabled: 1
      autorefresh: 1
    - id: module_server_applications_pool_repo
      name: module_server_applications_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs"}/SUSE/Products/SLE-Module-Server-Applications/15-SP2/x86_64/product
      enabled: 1
      autorefresh: 1
    - id: tools_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/SLE15-Uyuni-Client-Tools/SLE_15/
      enabled: true
      gpgcheck: false
      name: tools_pool_repo

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ else }
packages: ["avahi", "nss-mdns", "qemu-guest-agent"]
%{ endif }

runcmd:
  # WORKAROUND: cloud-init in SLES 15 SP2 does not take care of the following
  - "systemctl start 'qemu-ga@virtio\\x2dports-org.qemu.guest_agent.0'"
%{ endif }

%{ if image == "sles15sp3o" }
zypper:
  repos:
    - id: os_pool_repo
      name: os_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs"}/SUSE/Products/SLE-Module-Basesystem/15-SP3/x86_64/product
      enabled: 1
      autorefresh: 1
    - id: tools_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/SLE15-Uyuni-Client-Tools/SLE_15/
      enabled: true
      gpgcheck: false
      name: tools_pool_repo

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ else }
packages: ["avahi", "nss-mdns", "qemu-guest-agent"]
%{ endif }

runcmd:
  # WORKAROUND: cloud-init in SLES 15 SP3 does not take care of the following
  - "systemctl start 'qemu-ga@virtio\\x2dports-org.qemu.guest_agent.0'"
%{ endif }

%{ if image == "sles15sp4o" }
zypper:
  repos:
    - id: os_pool_repo
      name: os_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs"}/SUSE/Products/SLE-Module-Basesystem/15-SP4/x86_64/product
      enabled: 1
      autorefresh: 1
    - id: tools_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/SLE15-Uyuni-Client-Tools/SLE_15/
      enabled: true
      gpgcheck: false
      name: tools_pool_repo

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ else }
packages: ["avahi", "nss-mdns", "qemu-guest-agent"]
%{ endif }

runcmd:
  # WORKAROUND: cloud-init in SLES 15 SP4 does not take care of the following
  - "systemctl start 'qemu-ga@virtio\\x2dports-org.qemu.guest_agent.0'"
%{ endif }

%{ if image == "sles15sp5o" }
zypper:
  repos:
    - id: os_pool_repo
      name: os_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs"}/SUSE/Products/SLE-Module-Basesystem/15-SP5/x86_64/product
      enabled: 1
      autorefresh: 1
    - id: tools_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/SLE15-Uyuni-Client-Tools/SLE_15/
      enabled: true
      gpgcheck: false
      name: tools_pool_repo

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ else }
packages: ["avahi", "nss-mdns", "qemu-guest-agent"]
%{ endif }

runcmd:
  # WORKAROUND: cloud-init in SLES 15 SP5 does not take care of the following
  # TODO: Check!
  - "systemctl start 'qemu-ga@virtio\\x2dports-org.qemu.guest_agent.0'"
%{ endif }

%{ if image == "slemicro55o" }

write_files: ${ files }

zypper:
  repos:
%{ if container_proxy || container_server }
    - id: container_tools_repo
      name: container_tools_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs" }/Devel:/Galaxy:/Manager:/Head/SLE_15_SP5/
      enabled: 1
      autorefresh: 1
      gpgcheck: false
%{ endif }
%{ if testsuite }
    # Required only for wget
    - id: os_pool_repo
      name: os_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs"}/SUSE/Products/SLE-Module-Basesystem/15-SP5/x86_64/product
      enabled: 1
      autorefresh: 1
      gpgcheck: false
%{ endif }
    - id: ca_suse
      name: ca_suse
      baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org" }/repositories/SUSE:/CA/SLE_15_SP5/
      enabled: 1
      autorefresh: 1
      gpgcheck: false
    - id: micro_pool_repo
      name: micro_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs" }/SUSE/Products/SLE-Micro/5.5/x86_64/product/
      enabled: 1
      autorefresh: 1
      gpgcheck: false
    - id: micro_update_repo
      name: micro_update_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.suse.de/ibs" }/SUSE/Updates/SLE-Micro/5.5/x86_64/update/
      enabled: 1
      autorefresh: 1
      gpgcheck: false

runcmd:
  - [transactional-update, run, sh, -c, "for key in $(ls /etc/gpg_keys); do rpm --import /etc/gpg_keys/$key; done" ]
  - [ zypper, mr, -a, -g ]
%{ if testsuite }
  # Packages needed for the testsuite
  - [ transactional-update, --continue, --non-interactive, pkg, install, wget, timezone, aaa_base-extras, ca-certificates ]
%{ endif }
%{ if container_server }
  - [ transactional-update, --continue, --non-interactive, pkg, install, mgrctl, mgradm, netavark, aardvark-dns, ca-certificates-suse ]
%{ endif }
%{ if container_proxy }
  - [ transactional-update, --continue, --non-interactive, pkg, install, mgrctl, mgrpxy, ca-certificates-suse ]
%{ endif }
%{ if install_salt_bundle }
  - [ transactional-update, --continue, --non-interactive, pkg, install, qemu-guest-agent, venv-salt-minion, avahi ]
%{ else }
  - [ transactional-update, --continue, --non-interactive, pkg, install, qemu-guest-agent, salt-minion, avahi ]
%{ endif }
  - [ reboot ]
%{ endif }

%{ if image == "ubuntu2004o" }

apt:
  sources:
    tools_pool_repo:
      source: deb http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/Ubuntu2004-Uyuni-Client-Tools/xUbuntu_20.04/ /
      key: |
        -----BEGIN PGP PUBLIC KEY BLOCK-----
        Version: GnuPG v1.4.5 (GNU/Linux)

        mQENBFsnulUBCADNjL4hvhVtSzqVDlMtFFFP28Acq+UNF8WKKMhbBirfOpXwwI1C
        NR3i0CXPOce5eKShuuWAjD2E36e2XAp3rUAo/aCA7UgtJkMNKzzlTOcqHHxKTx6H
        gvp0Fb6xTKywZ7VttGhwUynl+CsDuOst3ROXTNdb8XMfm4joH2FW5D3ACN2qNiv0
        MVcFNKxQ98w8M9xJxdI8DuyngnSeZwAosNzEio3JhTPiTv9ngY2Z3AuYUcwTEt7o
        feEN+ivAgYnn+a6DBKFBeCW7VUD3V+tH8/fKnkvI4gf2o3N7Ok+/uE+DPUBb+14f
        +9dhBjd+7+pR3ayEZFjQns5XFShoYu2+CQspABEBAAG0UHN5c3RlbXNtYW5hZ2Vt
        ZW50OlV5dW5pIE9CUyBQcm9qZWN0IDxzeXN0ZW1zbWFuYWdlbWVudDpVeXVuaUBi
        dWlsZC5vcGVuc3VzZS5vcmc+iQE+BBMBCAAoBQJjQDEEAhsDBQkMNyavBgsJCAcD
        AgYVCAIJCgsEFgIDAQIeAQIXgAAKCRCXLl1sDSCDPjsSCAC1v9YHwuP0kRt8VPlq
        /RLgADb5TsUPOaDcZ/maKVxhL5EgY2mX1ViCO4Bm+VFL2ZSJEXth8/Zp/dZe80e9
        tlZgag5uPQe9FV0IAHXYt91DYJlE7VuxvdhADIt9RcDmS4OrSAfQoroyh5OW3ZRW
        Kqa68L6RBhiyuvBTaRCUdIhqDBjVCgMlLJxC5soOIVCEvMRzOxHqO0+gvKomvM1P
        iK4cio2OcIqZb8vCyMIXtYniHqA0rUZD4U+EB9enmYcj9ZhWO9oQXZ0qCQN6ve/K
        1Q7NjImT5oEHWGFeLmwWZMe2+djFcHiCQM1bFN1gC+2ASz5XPC7OKdrIi+E85gMo
        cYu+iEYEExECAAYFAlsnulUACgkQOzARt2udZSO/4QCcDf+j/XRbJn2PudsSoyjw
        3B2boakAnA9A9b8UoEYgmLTRpwXYuhsxOCDE
        =8MsV
        -----END PGP PUBLIC KEY BLOCK-----

runcmd:
  # WORKAROUND: cloud-init in Ubuntu 20.04 does not take care of the following
  - echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
  # WORKAROUND: disable IPv6 until we have it in Provo
  - echo 'Acquire::ForceIPv4 "true";' > /etc/apt/apt.conf.d/99force-ipv4
  - systemctl restart sshd
  - systemctl start qemu-guest-agent

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi-daemon", "qemu-guest-agent"]
%{ else }
packages: ["salt-minion", "avahi-daemon", "qemu-guest-agent"]
%{ endif }
%{ endif }
%{ if image == "ubuntu2204o" }

apt:
  sources:
    tools_pool_repo:
      source: deb http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/Ubuntu2204-Uyuni-Client-Tools/xUbuntu_22.04/ /
      key: |
        -----BEGIN PGP PUBLIC KEY BLOCK-----
        Version: GnuPG v1.4.5 (GNU/Linux)

        mQENBFsnulUBCADNjL4hvhVtSzqVDlMtFFFP28Acq+UNF8WKKMhbBirfOpXwwI1C
        NR3i0CXPOce5eKShuuWAjD2E36e2XAp3rUAo/aCA7UgtJkMNKzzlTOcqHHxKTx6H
        gvp0Fb6xTKywZ7VttGhwUynl+CsDuOst3ROXTNdb8XMfm4joH2FW5D3ACN2qNiv0
        MVcFNKxQ98w8M9xJxdI8DuyngnSeZwAosNzEio3JhTPiTv9ngY2Z3AuYUcwTEt7o
        feEN+ivAgYnn+a6DBKFBeCW7VUD3V+tH8/fKnkvI4gf2o3N7Ok+/uE+DPUBb+14f
        +9dhBjd+7+pR3ayEZFjQns5XFShoYu2+CQspABEBAAG0UHN5c3RlbXNtYW5hZ2Vt
        ZW50OlV5dW5pIE9CUyBQcm9qZWN0IDxzeXN0ZW1zbWFuYWdlbWVudDpVeXVuaUBi
        dWlsZC5vcGVuc3VzZS5vcmc+iQE+BBMBCAAoBQJjQDEEAhsDBQkMNyavBgsJCAcD
        AgYVCAIJCgsEFgIDAQIeAQIXgAAKCRCXLl1sDSCDPjsSCAC1v9YHwuP0kRt8VPlq
        /RLgADb5TsUPOaDcZ/maKVxhL5EgY2mX1ViCO4Bm+VFL2ZSJEXth8/Zp/dZe80e9
        tlZgag5uPQe9FV0IAHXYt91DYJlE7VuxvdhADIt9RcDmS4OrSAfQoroyh5OW3ZRW
        Kqa68L6RBhiyuvBTaRCUdIhqDBjVCgMlLJxC5soOIVCEvMRzOxHqO0+gvKomvM1P
        iK4cio2OcIqZb8vCyMIXtYniHqA0rUZD4U+EB9enmYcj9ZhWO9oQXZ0qCQN6ve/K
        1Q7NjImT5oEHWGFeLmwWZMe2+djFcHiCQM1bFN1gC+2ASz5XPC7OKdrIi+E85gMo
        cYu+iEYEExECAAYFAlsnulUACgkQOzARt2udZSO/4QCcDf+j/XRbJn2PudsSoyjw
        3B2boakAnA9A9b8UoEYgmLTRpwXYuhsxOCDE
        =8MsV
        -----END PGP PUBLIC KEY BLOCK-----

runcmd:
  # WORKAROUND: cloud-init in Ubuntu 22.04 does not take care of the following
  - echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
  # WORKAROUND: disable IPv6 until we have it in Provo
  - echo 'Acquire::ForceIPv4 "true";' > /etc/apt/apt.conf.d/99force-ipv4
  - systemctl restart sshd
  - systemctl start qemu-guest-agent

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi-daemon", "qemu-guest-agent"]
%{ else }
packages: ["salt-minion", "avahi-daemon", "qemu-guest-agent"]
%{ endif }
%{ endif }
%{ if image == "debian12o" }
apt:
  sources:
    tools_pool_repo:
      source: deb http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/Debian12-Uyuni-Client-Tools/Debian_12/ /
      key: |
        -----BEGIN PGP PUBLIC KEY BLOCK-----
        Version: GnuPG v1.4.5 (GNU/Linux)

        mQENBFsnulUBCADNjL4hvhVtSzqVDlMtFFFP28Acq+UNF8WKKMhbBirfOpXwwI1C
        NR3i0CXPOce5eKShuuWAjD2E36e2XAp3rUAo/aCA7UgtJkMNKzzlTOcqHHxKTx6H
        gvp0Fb6xTKywZ7VttGhwUynl+CsDuOst3ROXTNdb8XMfm4joH2FW5D3ACN2qNiv0
        MVcFNKxQ98w8M9xJxdI8DuyngnSeZwAosNzEio3JhTPiTv9ngY2Z3AuYUcwTEt7o
        feEN+ivAgYnn+a6DBKFBeCW7VUD3V+tH8/fKnkvI4gf2o3N7Ok+/uE+DPUBb+14f
        +9dhBjd+7+pR3ayEZFjQns5XFShoYu2+CQspABEBAAG0UHN5c3RlbXNtYW5hZ2Vt
        ZW50OlV5dW5pIE9CUyBQcm9qZWN0IDxzeXN0ZW1zbWFuYWdlbWVudDpVeXVuaUBi
        dWlsZC5vcGVuc3VzZS5vcmc+iQE+BBMBCAAoBQJjQDEEAhsDBQkMNyavBgsJCAcD
        AgYVCAIJCgsEFgIDAQIeAQIXgAAKCRCXLl1sDSCDPjsSCAC1v9YHwuP0kRt8VPlq
        /RLgADb5TsUPOaDcZ/maKVxhL5EgY2mX1ViCO4Bm+VFL2ZSJEXth8/Zp/dZe80e9
        tlZgag5uPQe9FV0IAHXYt91DYJlE7VuxvdhADIt9RcDmS4OrSAfQoroyh5OW3ZRW
        Kqa68L6RBhiyuvBTaRCUdIhqDBjVCgMlLJxC5soOIVCEvMRzOxHqO0+gvKomvM1P
        iK4cio2OcIqZb8vCyMIXtYniHqA0rUZD4U+EB9enmYcj9ZhWO9oQXZ0qCQN6ve/K
        1Q7NjImT5oEHWGFeLmwWZMe2+djFcHiCQM1bFN1gC+2ASz5XPC7OKdrIi+E85gMo
        cYu+iEYEExECAAYFAlsnulUACgkQOzARt2udZSO/4QCcDf+j/XRbJn2PudsSoyjw
        3B2boakAnA9A9b8UoEYgmLTRpwXYuhsxOCDE
        =8MsV
        -----END PGP PUBLIC KEY BLOCK-----

runcmd:
  # HACK: cloud-init in Debian 12 does not take care of the following
  - echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
  - systemctl restart sshd
  - systemctl start qemu-guest-agent

bootcmd:
  # HACK: Make "gnupg" to be installed before configuring repos, so gpg key can be imported
  - DEBIAN_FRONTEND=noninteractive apt-get -yq update
  - DEBIAN_FRONTEND=noninteractive apt-get -yq install gnupg

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi-daemon", "qemu-guest-agent", "gnupg"]
%{ else }
packages: ["salt-minion", "avahi-daemon", "qemu-guest-agent", "gnupg"]
%{ endif }
%{ endif }
%{ if image == "debian11o" }
apt:
  sources:
    tools_pool_repo:
      source: deb http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/Debian11-Uyuni-Client-Tools/Debian_11/ /
      key: |
        -----BEGIN PGP PUBLIC KEY BLOCK-----
        Version: GnuPG v1.4.5 (GNU/Linux)

        mQENBFsnulUBCADNjL4hvhVtSzqVDlMtFFFP28Acq+UNF8WKKMhbBirfOpXwwI1C
        NR3i0CXPOce5eKShuuWAjD2E36e2XAp3rUAo/aCA7UgtJkMNKzzlTOcqHHxKTx6H
        gvp0Fb6xTKywZ7VttGhwUynl+CsDuOst3ROXTNdb8XMfm4joH2FW5D3ACN2qNiv0
        MVcFNKxQ98w8M9xJxdI8DuyngnSeZwAosNzEio3JhTPiTv9ngY2Z3AuYUcwTEt7o
        feEN+ivAgYnn+a6DBKFBeCW7VUD3V+tH8/fKnkvI4gf2o3N7Ok+/uE+DPUBb+14f
        +9dhBjd+7+pR3ayEZFjQns5XFShoYu2+CQspABEBAAG0UHN5c3RlbXNtYW5hZ2Vt
        ZW50OlV5dW5pIE9CUyBQcm9qZWN0IDxzeXN0ZW1zbWFuYWdlbWVudDpVeXVuaUBi
        dWlsZC5vcGVuc3VzZS5vcmc+iQE+BBMBCAAoBQJjQDEEAhsDBQkMNyavBgsJCAcD
        AgYVCAIJCgsEFgIDAQIeAQIXgAAKCRCXLl1sDSCDPjsSCAC1v9YHwuP0kRt8VPlq
        /RLgADb5TsUPOaDcZ/maKVxhL5EgY2mX1ViCO4Bm+VFL2ZSJEXth8/Zp/dZe80e9
        tlZgag5uPQe9FV0IAHXYt91DYJlE7VuxvdhADIt9RcDmS4OrSAfQoroyh5OW3ZRW
        Kqa68L6RBhiyuvBTaRCUdIhqDBjVCgMlLJxC5soOIVCEvMRzOxHqO0+gvKomvM1P
        iK4cio2OcIqZb8vCyMIXtYniHqA0rUZD4U+EB9enmYcj9ZhWO9oQXZ0qCQN6ve/K
        1Q7NjImT5oEHWGFeLmwWZMe2+djFcHiCQM1bFN1gC+2ASz5XPC7OKdrIi+E85gMo
        cYu+iEYEExECAAYFAlsnulUACgkQOzARt2udZSO/4QCcDf+j/XRbJn2PudsSoyjw
        3B2boakAnA9A9b8UoEYgmLTRpwXYuhsxOCDE
        =8MsV
        -----END PGP PUBLIC KEY BLOCK-----

runcmd:
  # HACK: cloud-init in Debian 11 does not take care of the following
  - echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
  - systemctl restart sshd
  - systemctl start qemu-guest-agent
  # WORKAROUND: security release/updates does not have a Release file
  - sed -i "s|bullseye/updates|bullseye-security|" /etc/apt/sources.list

bootcmd:
  # HACK: Make "gnupg" to be installed before configuring repos, so gpg key can be imported
  - DEBIAN_FRONTEND=noninteractive apt-get -yq update
  - DEBIAN_FRONTEND=noninteractive apt-get -yq install gnupg

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi-daemon", "qemu-guest-agent", "gnupg", "python3-apt"]
%{ else }
packages: ["salt-minion", "avahi-daemon", "qemu-guest-agent", "gnupg", "python3-apt"]
%{ endif }
%{ endif }
%{ if image == "debian10o" }
apt:
  sources:
    tools_pool_repo:
      source: deb http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/Debian10-Uyuni-Client-Tools/Debian_10/ /
      key: |
        -----BEGIN PGP PUBLIC KEY BLOCK-----
        Version: GnuPG v1.4.5 (GNU/Linux)

        mQENBFsnulUBCADNjL4hvhVtSzqVDlMtFFFP28Acq+UNF8WKKMhbBirfOpXwwI1C
        NR3i0CXPOce5eKShuuWAjD2E36e2XAp3rUAo/aCA7UgtJkMNKzzlTOcqHHxKTx6H
        gvp0Fb6xTKywZ7VttGhwUynl+CsDuOst3ROXTNdb8XMfm4joH2FW5D3ACN2qNiv0
        MVcFNKxQ98w8M9xJxdI8DuyngnSeZwAosNzEio3JhTPiTv9ngY2Z3AuYUcwTEt7o
        feEN+ivAgYnn+a6DBKFBeCW7VUD3V+tH8/fKnkvI4gf2o3N7Ok+/uE+DPUBb+14f
        +9dhBjd+7+pR3ayEZFjQns5XFShoYu2+CQspABEBAAG0UHN5c3RlbXNtYW5hZ2Vt
        ZW50OlV5dW5pIE9CUyBQcm9qZWN0IDxzeXN0ZW1zbWFuYWdlbWVudDpVeXVuaUBi
        dWlsZC5vcGVuc3VzZS5vcmc+iQE+BBMBCAAoBQJjQDEEAhsDBQkMNyavBgsJCAcD
        AgYVCAIJCgsEFgIDAQIeAQIXgAAKCRCXLl1sDSCDPjsSCAC1v9YHwuP0kRt8VPlq
        /RLgADb5TsUPOaDcZ/maKVxhL5EgY2mX1ViCO4Bm+VFL2ZSJEXth8/Zp/dZe80e9
        tlZgag5uPQe9FV0IAHXYt91DYJlE7VuxvdhADIt9RcDmS4OrSAfQoroyh5OW3ZRW
        Kqa68L6RBhiyuvBTaRCUdIhqDBjVCgMlLJxC5soOIVCEvMRzOxHqO0+gvKomvM1P
        iK4cio2OcIqZb8vCyMIXtYniHqA0rUZD4U+EB9enmYcj9ZhWO9oQXZ0qCQN6ve/K
        1Q7NjImT5oEHWGFeLmwWZMe2+djFcHiCQM1bFN1gC+2ASz5XPC7OKdrIi+E85gMo
        cYu+iEYEExECAAYFAlsnulUACgkQOzARt2udZSO/4QCcDf+j/XRbJn2PudsSoyjw
        3B2boakAnA9A9b8UoEYgmLTRpwXYuhsxOCDE
        =8MsV
        -----END PGP PUBLIC KEY BLOCK-----

runcmd:
#   HACK: cloud-init in Debian 10 does not take care of the following
  - echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
  - systemctl restart sshd
  - systemctl start qemu-guest-agent

bootcmd:
  # HACK: Make "gnupg" to be installed before configuring repos, so gpg key can be imported
  - DEBIAN_FRONTEND=noninteractive apt-get -yq update
  - DEBIAN_FRONTEND=noninteractive apt-get -yq install gnupg

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi-daemon", "qemu-guest-agent", "apt-transport-https", "python-apt", "python3-apt"]
%{ else }
packages: ["salt-minion", "avahi-daemon", "qemu-guest-agent", "apt-transport-https", "python-apt", "python3-apt"]
%{ endif }
%{ endif }

%{ if image == "amazonlinux2o" }

yum_repos:
  # repo for salt
  tools_pool_repo:
    baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/CentOS7-Uyuni-Client-Tools/CentOS_7/
    failovermethod: priority
    enabled: true
    gpgcheck: false
    name: tools_pool_repo
  # repo for nss-mdns
  epel:
    baseurl: http://download.fedoraproject.org/pub/epel/7/$basearch
    mirrorlist: https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=$basearch
    failovermethod: priority
    enabled: true
    gpgcheck: false
    name: epel

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ else }
packages: ["salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ endif }

%{ endif }

%{ if image == "almalinux8o" }
yum_repos:
  # repo for salt
  tools_pool_repo:
    baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/EL8-Uyuni-Client-Tools/EL_8/
    enabled: true
    gpgcheck: false
    name: tools_pool_repo
  # repo for nss-mdns
  epel:
    baseurl: http://download.fedoraproject.org/pub/epel/8/Everything/$basearch
    mirrorlist: https://mirrors.fedoraproject.org/metalink?repo=epel-8&arch=$basearch
    enabled: true
    gpgcheck: false
    name: epel

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
%{ else }
packages: ["avahi", "nss-mdns", "qemu-guest-agent", "salt-minion"]
%{ endif }

%{ endif }

%{ if image == "almalinux9o" }
yum_repos:
  # repo for salt
  tools_pool_repo:
    baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/EL9-Uyuni-Client-Tools/EL_9/
    enabled: true
    gpgcheck: false
    name: tools_pool_repo
  # repo for nss-mdns
  epel:
    baseurl: http://download.fedoraproject.org/pub/epel/9/Everything/$basearch
    mirrorlist: https://mirrors.fedoraproject.org/metalink?repo=epel-9&arch=$basearch
    enabled: true
    gpgcheck: false
    name: epel

runcmd:
  # WORKAROUND: cloud-init in Alma 9 does not take care of the following
  - echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
  - systemctl restart sshd

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent", "dbus-tools"]
%{ else }
packages: ["avahi", "nss-mdns", "qemu-guest-agent", "salt-minion", "dbus-tools"]
%{ endif }

%{ endif }

%{ if image == "libertylinux9o" }
yum_repos:
  # repo for salt
  tools_pool_repo:
    baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/EL9-Uyuni-Client-Tools/EL_9/
    enabled: true
    gpgcheck: false
    name: tools_pool_repo
  # repo for nss-mdns
  epel:
    baseurl: http://download.fedoraproject.org/pub/epel/9/Everything/$basearch
    mirrorlist: https://mirrors.fedoraproject.org/metalink?repo=epel-9&arch=$basearch
    enabled: true
    gpgcheck: false
    name: epel

runcmd:
  # Registration with SUSEConnect
  - curl http://rmt.scc.suse.de/tools/rmt-client-setup-res --output rmt-client-setup-res
  # WORKARAOUND for https://github.com/SUSE/rmt/issues/994
  - sed -i -e's/REGURL=$1;;/REGURL="http:\/\/\$\{RMTNAME\}";;/' rmt-client-setup-res
  - yes | sh rmt-client-setup-res https://rmt.scc.suse.de
  # Packages installation after registration
  - dnf config-manager --set-enabled epel
%{ if install_salt_bundle }
  - dnf -y install venv-salt-minion avahi nss-mdns
%{ else }
  - dnf -y install avahi nss-mdns salt-minion
%{ endif }
  # WORKAROUND: cloud-init in Liberty 9 does not take care of the following
  - dnf -y install dbus-tools
  - echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
  - systemctl restart sshd

%{ endif }

%{ if image == "rocky8o" }
yum_repos:
  # repo for salt
  tools_pool_repo:
    baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/EL8-Uyuni-Client-Tools/EL_8
    enabled: true
    gpgcheck: false
    name: tools_pool_repo
  # repo for nss-mdns
  epel:
    baseurl: http://download.fedoraproject.org/pub/epel/8/Everything/$basearch
    mirrorlist: https://mirrors.fedoraproject.org/metalink?repo=epel-8&arch=$basearch
    enabled: true
    gpgcheck: false
    name: epel

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns"]
%{ else }
packages: ["avahi", "nss-mdns", "salt-minion"]
%{ endif }

%{ endif }

%{ if image == "rocky9o" }
yum_repos:
  # repo for salt
  tools_pool_repo:
    baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/EL9-Uyuni-Client-Tools/EL_9
    enabled: true
    gpgcheck: false
    name: tools_pool_repo
  # repo for nss-mdns
  epel:
    baseurl: http://download.fedoraproject.org/pub/epel/9/Everything/$basearch
    mirrorlist: https://mirrors.fedoraproject.org/metalink?repo=epel-9&arch=$basearch
    enabled: true
    gpgcheck: false
    name: epel

runcmd:
  # WORKAROUND: cloud-init in Rocky 9 does not take care of the following
  - echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
  - systemctl restart sshd

%{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns"]
%{ else }
packages: ["avahi", "nss-mdns", "salt-minion"]
%{ endif }
%{ endif }

%{ if image == "oraclelinux8o" }
yum_repos:
  # repo for salt
  tools_pool_repo:
    baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/EL8-Uyuni-Client-Tools/EL_8
    enabled: true
    gpgcheck: false
    name: tools_pool_repo
  # repo for nss-mdns
  epel:
    baseurl: http://download.fedoraproject.org/pub/epel/8/Everything/$basearch
    mirrorlist: https://mirrors.fedoraproject.org/metalink?repo=epel-8&arch=$basearch
    enabled: true
    gpgcheck: false
    name: epel

  %{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent"]
  %{ else }
packages: ["avahi", "nss-mdns", "qemu-guest-agent", "salt-minion"]
  %{ endif }

  %{ endif }

%{ if image == "oraclelinux9o" }
yum_repos:
  # repo for salt
  tools_pool_repo:
    baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/EL9-Uyuni-Client-Tools/EL_9
    enabled: true
    gpgcheck: false
    name: tools_pool_repo
  # repo for nss-mdns
  epel:
    baseurl: http://download.fedoraproject.org/pub/epel/9/Everything/$basearch
    mirrorlist: https://mirrors.fedoraproject.org/metalink?repo=epel-9&arch=$basearch
    enabled: true
    gpgcheck: false
    name: epel

runcmd:
  # WORKAROUND: cloud-init in Oracle 9 does not take care of the following
  - echo "PermitRootLogin yes" >> /etc/ssh/sshd_config
  - systemctl restart sshd

  %{ if install_salt_bundle }
packages: ["venv-salt-minion", "avahi", "nss-mdns", "qemu-guest-agent", "dbus-tools", "tar"]
  %{ else }
packages: ["avahi", "nss-mdns", "qemu-guest-agent", "salt-minion", "dbus-tools", "tar"]
  %{ endif }

%{ endif }

%{ if image == "opensuse154armo" }
zypper:
  repos:
    - id: tools_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/openSUSE_Leap_15-Uyuni-Client-Tools/openSUSE_Leap_15.0/
      enabled: true
      gpgcheck: false
      name: tools_pool_repo

%{ if install_salt_bundle }
packages: ["venv-salt-minion"]
%{ else }
packages: ["salt-minion"]
%{ endif }

runcmd:
  - zypper removerepo --all
%{ endif }

%{ if image == "opensuse155armo" }
zypper:
  repos:
    - id: tools_pool_repo
      baseurl: http://${ use_mirror_images ? mirror : "download.opensuse.org"}/repositories/systemsmanagement:/Uyuni:/Stable:/openSUSE_Leap_15-Uyuni-Client-Tools/openSUSE_Leap_15.0/
      enabled: true
      gpgcheck: false
      name: tools_pool_repo

%{ if install_salt_bundle }
packages: ["venv-salt-minion"]
%{ else }
packages: ["salt-minion"]
%{ endif }

runcmd:
  - zypper removerepo --all
%{ endif }
